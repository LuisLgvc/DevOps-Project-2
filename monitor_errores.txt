#!/bin/bash

# Ruta del log de acceso de Apache
ACCESS_LOG="/var/log/apache2/access.log"

# Umbral de errores para generar alerta
THRESHOLD=10

# Intervalo simulado (informativo)
INTERVAL=60

# Direcci√≥n de correo destino
EMAIL="luis.dvlp.03@gmail.com"

# Contar cu√°ntas veces aparecen errores en las √∫ltimas 100 l√≠neas del log de acceso
COUNT=$(tail -n 100 "$ACCESS_LOG" | grep "[error\]" | wc -l)

echo "Errores encontrados: $COUNT"

if [ "$COUNT" -gt "$THRESHOLD" ]; then
    SUBJECT="‚ö†Ô∏è Alerta de Errores en Apache"
    MESSAGE="ALERTA üö®: Se detectaron $COUNT errores en los √∫ltimos $INTERVAL segundos."

    echo "$MESSAGE" | mail -s "$SUBJECT" "$EMAIL"
    echo "$(date "+%Y-%m-%d %H:%M:%S") - $MESSAGE" | sudo tee -a /var/log/apache_error_monitor.log
else
    echo "No se alcanz√≥ el umbral de errores ($THRESHOLD). No se env√≠a correo."
fi
